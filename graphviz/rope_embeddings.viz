digraph RoPE_YaRN {
    rankdir=TB;
    bgcolor="lightgray";
    node [shape=none, fontname="Courier"];

    x [label=<
        <TABLE BORDER="1" CELLBORDER="1" CELLSPACING="0" BGCOLOR="white">
            <TR><TD COLSPAN="4" BGCOLOR="lightblue">Input Q/K Vector (x)</TD></TR>
            <TR><TD>1.0</TD><TD>2.0</TD><TD>3.0</TD><TD>4.0</TD></TR>
        </TABLE>
    >];

    cache [label=<
        <TABLE BORDER="1" CELLBORDER="1" CELLSPACING="0" BGCOLOR="white">
            <TR><TD COLSPAN="4" BGCOLOR="palegreen">Base sin/cos cache — base angle</TD></TR>
            <TR><TD COLSPAN="4">theta_i(p) = p / 10000^(2 * i / d)</TD></TR>
            <TR><TD>θ0=0.50</TD><TD>θ1=1.00</TD><TD>θ2=1.50</TD><TD>θ3=2.00</TD></TR>
            <TR><TD COLSPAN="4" BGCOLOR="mistyrose"><B>YaRN scaling:</B> alpha(p) = (L_target / L_train)^(p / L_target)</TD></TR>
            <TR><TD COLSPAN="4">Equivalent: alpha(p) = exp( (p / L_target) * ln(L_target / L_train) )</TD></TR>
            <TR><TD COLSPAN="4">Example: L_train=2048, L_target=8192, p=1000 → alpha ≈ 1.18</TD></TR>
        </TABLE>
    >];

    scaling [label=<
        <TABLE BORDER="1" CELLBORDER="1" CELLSPACING="0" BGCOLOR="white">
            <TR><TD COLSPAN="4" BGCOLOR="orange">YaRN Scaling Factors α(i)</TD></TR>
            <TR><TD>α0=1.2</TD><TD>α1=1.2</TD><TD>α2=0.8</TD><TD>α3=0.8</TD></TR>
            <TR><TD COLSPAN="4">θ' (i) = θ(i) * α(i)</TD></TR>
        </TABLE>
    >];

    cache_scaled [label=<
        <TABLE BORDER="1" CELLBORDER="1" CELLSPACING="0" BGCOLOR="white">
            <TR><TD COLSPAN="4" BGCOLOR="gold">Scaled Sin/Cos Cache</TD></TR>
            <TR><TD>cos(θ'0)</TD><TD>sin(θ'0)</TD><TD>cos(θ'1)</TD><TD>sin(θ'1)</TD></TR>
            <TR><TD>0.81</TD><TD>0.59</TD><TD>0.36</TD><TD>0.93</TD></TR>
        </TABLE>
    >];

    rot [label=<
        <TABLE BORDER="1" CELLBORDER="1" CELLSPACING="0" BGCOLOR="khaki">
            <TR><TD COLSPAN="8"><B>RoPE + YaRN Rotation</B><BR/>y_{2i} = x_{2i}*cos(θ'_i) - x_{2i+1}*sin(θ'_i) &nbsp; y_{2i+1} = x_{2i}*sin(θ'_i) + x_{2i+1}*cos(θ'_i)</TD></TR>
            <TR><TD COLSPAN="4" BGCOLOR="gray90"><B>Pair (x0=1.0, x1=2.0, θ'0)</B></TD><TD COLSPAN="4" BGCOLOR="gray90"><B>Pair (x2=3.0, x3=4.0, θ'1)</B></TD></TR>
            <TR>
                <TD>(1.0*0.81)</TD><TD>(2.0*0.59)</TD><TD>(1.0*0.59)</TD><TD>(2.0*0.81)</TD>
                <TD>(3.0*0.36)</TD><TD>(4.0*0.93)</TD><TD>(3.0*0.93)</TD><TD>(4.0*0.36)</TD>
            </TR>
            <TR><TD>=0.81</TD><TD>=1.18</TD><TD>=0.59</TD><TD>=1.62</TD><TD>=1.08</TD><TD>=3.72</TD><TD>=2.79</TD><TD>=1.44</TD></TR>
            <TR><TD COLSPAN="2">(0.81 - 1.18) = -0.37</TD><TD COLSPAN="2">(0.59 + 1.62) = 2.21</TD><TD COLSPAN="2">(1.08 - 3.72) = -2.64</TD><TD COLSPAN="2">(2.79 + 1.44) = 4.23</TD></TR>
        </TABLE>
    >];

    y [label=<
        <TABLE BORDER="1" CELLBORDER="1" CELLSPACING="0" BGCOLOR="white">
            <TR><TD COLSPAN="4" BGCOLOR="lightcoral">Rotated Q/K Vector (RoPE+YaRN(x))</TD></TR>
            <TR><TD>-0.37</TD><TD>2.21</TD><TD>-2.64</TD><TD>4.23</TD></TR>
        </TABLE>
    >];

    x -> rot;
    cache -> scaling;
    scaling -> cache_scaled;
    cache_scaled -> rot;
    rot -> y;
}
